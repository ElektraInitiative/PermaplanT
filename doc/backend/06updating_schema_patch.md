# Why do we need the `schema.patch` file

When executing `diesel migration run` diesel connects to the database and
expresses the current schema of the database in the `schema.rs` file. The
config for this mechanism is in `diesel.toml`. You can use `diesel print-schema`
to output the schema manually. Unfortunately Diesel generates type definitions
for types we import from Postgis. This results in a double use:

```
diesel::table! {
    use postgis_diesel::sql_types::Geography; // <-- even though we import using --import-types
    use super::sql_types::Geography;          // <-- this gets generated by Diesel
```

After generating the `schema.rs` file Diesel applies the patch file to it.

# When to update `schema.patch` file

Whenever you get an error message similar to `error applying hunk #2` you have to update the `schema.patch` file.
This happens when `schema.rs` changes in the diff context of the patch file (the lines before and after the change).

# How to update the `schema.patch` file

1. Comment out the following line from `diesel.toml`:

   ```toml
   patch_file = "src/schema.patch"
   ```

2. Get a clean database with all migrations:

   ```bash
   cd backend && diesel database reset
   ```

   You should now have a generated `schema.rs` in the backend src folder.

3. Copy the `schema.rs` file e.g. to `schema_tmp.rs`.

4. Make the necessary changes to `schema_tmp.rs`.

5. In the backend directory run `diff -U6 src/schema.rs src/schema_tmp.rs > src/schema.patch`.

6. Add `patch_file = "src/schema.patch"` to the `diesel.toml` again.

7. Delete `schema_tmp.rs`.

From now on the newly generated patch file should be used by Diesel.
